{% extends 'TaskHelper/base.html' %}
{% load static %}

{% block title %}å‘˜å·¥è¯¦æƒ…{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">é¦–é¡µ</a></li>
{#    <li class="breadcrumb-item"><a href="{% url 'weekly_ranking' %}">å‘¨æ’è¡Œ</a></li>#}
    <li class="breadcrumb-item active" aria-current="page">{{ employee.name }}</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="card mb-4">
  <div class="card-body d-flex align-items-center gap-3">
    <img src="{{ employee.get_avatar_url }}" class="rounded-circle" width="80" height="80">
    <div>
      <h4 class="mb-0">{{ employee.name }}</h4>
      <small class="text-muted">å‘˜å·¥ç¼–å·ï¼š{{ employee.id }}</small>
    </div>
  </div>
</div>

<h5 class="mt-4">ğŸ“… æ¯æ—¥å®Œæˆæƒ…å†µ</h5>
<table class="table table-bordered table-hover mt-2">
  <thead class="table-light">
    <tr>
      <th>æ—¥æœŸ</th>
      <th>å®Œæˆæ•°</th>
      <th>é”™è¯¯æ•°</th>
    </tr>
  </thead>
  <tbody>
    {% for record in records %}
      <tr class="{% if record.errors > 5 %}table-danger{% elif record.completed >= 160 %}table-success{% endif %}">
        <td>{{ record.date }}</td>
        <td>{{ record.completed }}</td>
        <td>{{ record.errors }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="3" class="text-center">æš‚æ— è®°å½•</td></tr>
    {% endfor %}
  </tbody>
</table>

<h5 class="mt-5">ğŸ“Š çƒ­åŠ›å›¾è§†å›¾åˆ‡æ¢</h5>
<div class="btn-group mb-3" role="group">
  <button class="btn btn-outline-primary" onclick="showHeatmap('month')">æŒ‰æœˆ</button>
  <button class="btn btn-outline-secondary" onclick="showHeatmap('week')">æŒ‰å‘¨</button>
</div>

<div id="monthDayHeatmap" style="width: 100%; height: 480px; display: block;"></div>
<div id="weekDayHeatmap" style="min-width: 1000px; height: 600px; display: none;"></div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
function showHeatmap(type) {
  document.getElementById('monthDayHeatmap').style.display = type === 'month' ? 'block' : 'none';
  document.getElementById('weekDayHeatmap').style.display = type === 'week' ? 'block' : 'none';

  const chart = echarts.getInstanceByDom(
    document.getElementById(type === 'month' ? 'monthDayHeatmap' : 'weekDayHeatmap')
  );
  if (chart) chart.resize();
}

document.addEventListener('DOMContentLoaded', function () {
  const monthChart = echarts.init(document.getElementById('monthDayHeatmap'));
  monthChart.setOption({
    tooltip: {},
    visualMap: {
      min: 0,
      max: 200,
      calculable: true,
      orient: 'horizontal',
      left: 'center',
      bottom: 30,
      inRange: {
        color: ['#fef0d9', '#fdcc8a', '#fc8d59', '#d7301f']
      }
    },
    grid: {
      top: 60,
      bottom: 100,
      left: 80,
      right: 40,
      containLabel: true
    },
    xAxis: {
      type: 'category',
      name: 'æ—¥',
      axisLabel: { fontSize: 14 },
      data: Array.from({length: 31}, (_, i) => (i + 1).toString()),
      splitArea: { show: true }
    },
    yAxis: {
      type: 'category',
      name: 'æœˆ',
      axisLabel: { fontSize: 14 },
      data: ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'],
      splitArea: { show: true }
    },
    series: [{
      name: 'å®Œæˆæ•°',
      type: 'heatmap',
      data: {{ month_day_heatmap_data|safe }},
      label: { show: false },
      emphasis: {
        itemStyle: {
          shadowBlur: 10,
          shadowColor: 'rgba(0,0,0,0.5)'
        }
      }
    }]
  });

  const weekChart = echarts.init(document.getElementById('weekDayHeatmap'));
  weekChart.setOption({
    tooltip: {},
    visualMap: {
      min: 0,
      max: 200,
      calculable: true,
      orient: 'horizontal',
      left: 'center',
      bottom: 30,
      inRange: {
        color: ['#e0f3f8', '#74add1', '#4575b4']
      }
    },
    grid: {
      top: 60,
      bottom: 100,
      left: 100,
      right: 40,
      containLabel: true
    },
    xAxis: {
      type: 'category',
      name: 'æ˜ŸæœŸ',
      min: 0,
      max: 6,
      axisLabel: {
        fontSize: 14,
        interval: 0,
        formatter: function (val) {
          const map = { '1': 'ä¸€', '2': 'äºŒ', '3': 'ä¸‰', '4': 'å››', '5': 'äº”', '6': 'å…­', '7': 'æ—¥' };
          return 'å‘¨' + map[val];
        }
      },
      data: ['1','2','3','4','5','6','7'],
      splitArea: { show: true }
    },
    yAxis: {
      type: 'category',
      name: 'å‘¨',
      axisLabel: { fontSize: 14 },
      data: {{ week_day_labels|safe }},
      splitArea: { show: true }
    },
    series: [{
      name: 'å®Œæˆæ•°',
      type: 'heatmap',
      data: {{ week_day_heatmap_data|safe }},
      label: { show: false },
      emphasis: {
        itemStyle: {
          shadowBlur: 10,
          shadowColor: 'rgba(0,0,0,0.5)'
        }
      }
    }]
  });
});
</script>
{% endblock %}
